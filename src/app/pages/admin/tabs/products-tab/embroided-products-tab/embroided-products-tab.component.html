<div class="flex justify-content-end mb-3">
    <p-button label="Nuevo Producto" icon="pi pi-plus" [raised]="true" (onClick)="openProductDialog()" />
</div>

<p-table [value]="products" [loading]="productsLoading" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos" [rowsPerPageOptions]="[5, 10, 25, 50]" responsiveLayout="scroll"
    [tableStyle]="{'min-width': '50rem'}">

    <ng-template #header>
        <tr>
            <th pSortableColumn="id" class="text-center">
                ID <p-sortIcon field="id"></p-sortIcon>
                <p-columnFilter type="text" field="id" display="menu"></p-columnFilter>
            </th>
            <th pSortableColumn="name" class="text-center">
                Nombre <p-sortIcon field="name"></p-sortIcon>
                <p-columnFilter type="text" field="name" display="menu"></p-columnFilter>
            </th>
            <th class="text-center">Imagen</th>
            <th pSortableColumn="price" class="text-center">
                Precio <p-sortIcon field="price"></p-sortIcon>
                <p-columnFilter type="numeric" field="price" display="menu"></p-columnFilter>
            </th>
            <th class="text-center">Stock por Color/Talle</th>
            <th pSortableColumn="garmentType" class="text-center">
                Categoría <p-sortIcon field="garmentType"></p-sortIcon>
                <p-columnFilter type="text" field="garmentType" display="menu"></p-columnFilter>
            </th>
            <th pSortableColumn="rating" class="text-center">
                Rating <p-sortIcon field="rating"></p-sortIcon>
                <p-columnFilter type="numeric" field="rating" display="menu"></p-columnFilter>
            </th>
            <th class="text-center">Estado</th>
            <th class="text-center">Etiquetas</th>
            <th class="text-center">Acciones</th>
        </tr>
    </ng-template>

    <ng-template #body let-product>
        <tr>
            <td class="text-center">
                <span class="font-bold text-primary">{{ product.id }}</span>
            </td>
            <td class="text-center">
                <div class="flex flex-column align-items-center">
                    <span class="font-semibold text-900">{{ product.name }}</span>
                    <span class="text-sm text-600">{{ product.description | slice:0:50 }}{{ product.description.length > 50 ? '...' : '' }}</span>
                </div>
            </td>
            <td class="text-center">
                <p-image [src]="getProductImage(product)" [alt]="product.name" (onImageError)="onImageError($event, product)" imageClass="w-8rem h-8rem border-round object-cover"
                    class="border-round" preview="true" />
            </td>
            <td class="text-center">
                <div class="flex flex-column align-items-center">
                    <span *ngIf="product.discount > 0" class="text-sm text-500 line-through">{{ product.price | currency:'ARS':'symbol':'1.0-0' }}</span>
                    <span class="font-bold text-primary">{{ getDiscountedPrice(product) | currency:'ARS':'symbol':'1.0-0' }}</span>
                    <p-tag *ngIf="product.discount > 0" [value]="'-' + product.discount + '%'" severity="success" [rounded]="true"></p-tag>
                </div>
            </td>
            <td class="text-center">
                <div class="flex flex-column gap-1 align-items-center">
                    <div *ngFor="let variant of product.variants?.slice(0, 3)" class="flex flex-column gap-1 align-items-center">
                        <div class="flex align-items-center gap-1">
                            <div class="w-1rem h-1rem border-circle border-1 border-gray-300" [style.background-color]="getColorValue(variant.color)"></div>
                            <span class="text-xs font-semibold">{{ variant.color }}</span>
                        </div>
                        <div class="flex flex-wrap gap-1 justify-content-center">
                            <div *ngFor="let sizeStock of variant.sizes" class="flex flex-column align-items-center surface-50 p-1 border-round">
                                <span class="text-xs font-bold">{{ sizeStock.size }}</span>
                                <span class="text-xs" [class]="sizeStock.stock === 0 ? 'text-red-500' : sizeStock.stock <= 5 ? 'text-orange-500' : 'text-green-500'">
                                    {{ sizeStock.stock }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="(product.variants?.length || 0) > 3" class="flex align-items-center gap-1">
                        <p-tag [value]="'+' + ((product.variants?.length || 0) - 3) + ' colores más'" severity="info" [rounded]="true" size="small"></p-tag>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <p-tag [value]="getCategoryLabel(product.garmentType)" severity="info" [rounded]="true"></p-tag>
            </td>
            <td class="text-center">
                <div class="flex align-items-center justify-content-center gap-2">
                    <span class="font-semibold">{{ product.rating }}</span>
                    <i class="pi pi-star-fill text-yellow-500"></i>
                </div>
            </td>
            <td class="text-center">
                <div class="flex flex-column gap-1 align-items-center">
                    <p-tag *ngIf="product.isNew" value="Nuevo" severity="success" [rounded]="true" size="small"></p-tag>
                    <p-tag *ngIf="product.isFeatured" value="Destacado" severity="warn" [rounded]="true" size="small"></p-tag>
                    <span *ngIf="!product.isNew && !product.isFeatured" class="text-400 text-sm">Normal</span>
                </div>
            </td>
            <td class="text-center">
                <div class="flex flex-column gap-1 align-items-center">
                    <p-tag *ngFor="let tag of product.tags" [value]="getTagLabel(tag)" severity="secondary" [rounded]="true" size="small"></p-tag>
                    <span *ngIf="!product.tags || product.tags.length === 0" class="text-400 text-sm">Sin etiquetas</span>
                </div>
            </td>
            <td class="text-center">
                <div class="flex gap-2 justify-content-center">
                    <p-button icon="pi pi-pencil" (onClick)="editProduct(product)" [rounded]="true" size="small">
                    </p-button>
                    <p-button icon="pi pi-trash" (onClick)="confirmDeleteProduct(product)" [rounded]="true" severity="danger" size="small">
                    </p-button>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template #emptymessage>
        <tr>
            <td colspan="13" class="text-center py-6">
                <i class="pi pi-shopping-bag text-6xl text-300 mb-3 block"></i>
                <h3 class="text-xl font-semibold text-600 mb-2">No hay productos</h3>
                <p class="text-500 mb-4">Agrega tu primer producto para comenzar</p>
                <p-button label="Agregar Producto" icon="pi pi-plus" (onClick)="openProductDialog()" [rounded]="true"></p-button>
            </td>
        </tr>
    </ng-template>
</p-table>

<!-- Product Dialog -->
<p-dialog [header]="editingProduct ? 'Editar Producto' : 'Nuevo Producto'" [(visible)]="showProductDialog" [modal]="true" [style]="{width: '40rem', maxHeight: '90vh'}" [draggable]="false"
    [resizable]="false" [closable]="true" [closeOnEscape]="true" [dismissableMask]="false" styleClass="admin-dialog">

    <div class="dialog-content-wrapper">
        <form [formGroup]="productForm" class="flex flex-column gap-4">
            <!-- Only show ID field if editing -->
            <div class="grid" *ngIf="editingProduct">
                <div class="col-12">
                    <label for="productId" class="block mb-2 font-semibold">ID *</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-id-card"></i>
                        </p-inputgroup-addon>
                        <input id="productId" type="text" pInputText formControlName="id" class="w-full" placeholder="ID del producto" [disabled]="true" />
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('id')"></app-error-helper>
                </div>
            </div>

            <div class="grid">
                <div class="col-12">
                    <label for="productName" class="block mb-2 font-semibold">Nombre *</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-tag"></i>
                        </p-inputgroup-addon>
                        <input id="productName" type="text" pInputText formControlName="name" class="w-full" placeholder="Nombre del producto" />
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('name')"></app-error-helper>
                </div>
            </div>

            <div class="grid">
                <div class="col-12">
                    <label for="productDescription" class="block mb-2 font-semibold">Descripción *</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-file-edit"></i>
                        </p-inputgroup-addon>
                        <textarea pTextarea id="productDescription" formControlName="description" class="w-full" rows="3" placeholder="Descripción del producto"></textarea>
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('description')"></app-error-helper>
                </div>
            </div>



            <div class="grid">
                <div class="col-6">
                    <label for="productPrice" class="block mb-2 font-semibold">Precio *</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-dollar"></i>
                        </p-inputgroup-addon>
                        <p-inputnumber id="productPrice" formControlName="price" class="w-full" mode="currency" currency="ARS" locale="es-AR" [minFractionDigits]="0"
                            [maxFractionDigits]="0" placeholder="0" [showButtons]="true" [step]="100"></p-inputnumber>
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('price')"></app-error-helper>
                </div>
                <div class="col-6">
                    <label for="productDiscount" class="block mb-2 font-semibold">Descuento (%)</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-percentage"></i>
                        </p-inputgroup-addon>
                        <p-inputnumber id="productDiscount" formControlName="discount" class="w-full" [min]="0" [max]="100" suffix="%" placeholder="0" [showButtons]="true"></p-inputnumber>
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('discount')"></app-error-helper>
                </div>
            </div>

            <!-- Discounted Price and Final Price Section -->
            <div class="grid mb-3">
                <div class="col-12">
                    <div class="surface-100 p-3 border-round flex flex-column md:flex-row align-items-center gap-4">
                        <div class="flex align-items-center gap-2">
                            <span class="text-600">Precio original:</span>
                            <span class="font-bold">{{ productForm.get('price')?.value | currency:'ARS':'symbol':'1.0-0' }}</span>
                        </div>
                        <div class="flex align-items-center gap-2">
                            <span class="text-600">Descuento:</span>
                            <span class="font-bold text-green-600">{{ productForm.get('discount')?.value || 0 }}%</span>
                        </div>
                        <div class="flex align-items-center gap-2">
                            <span class="text-600">Precio final:</span>
                            <span class="font-bold text-primary">
                                {{ (productForm.get('price')?.value * (1 - (productForm.get('discount')?.value || 0) / 100)) | currency:'ARS':'symbol':'1.0-0' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid">

                <div class="col-6">
                    <label for="productRating" class="block mb-2 font-semibold">Rating</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-star"></i>
                        </p-inputgroup-addon>
                        <p-inputnumber id="productRating" formControlName="rating" class="w-full" [min]="0" [max]="5" [minFractionDigits]="1" [maxFractionDigits]="1" placeholder="0.0"
                            [showButtons]="true"></p-inputnumber>
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('rating')"></app-error-helper>
                </div>
            </div>

            <div class="grid">
                <div class="col-12">
                    <label for="productGarmentType" class="block mb-2 font-semibold">Categoría *</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-tag"></i>
                        </p-inputgroup-addon>
                        <p-select id="productGarmentType" formControlName="garmentType" [options]="productCategories" optionLabel="label" optionValue="value"
                            placeholder="Seleccionar categoría" class="w-full" appendTo="body"></p-select>
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('garmentType')"></app-error-helper>
                </div>
            </div>

            <!-- Variants Section -->
            <div class="grid">
                <div class="col-12">
                    <div class="surface-50 p-3 border-round">
                        <h4 class="font-semibold mb-3 flex align-items-center gap-2">
                            <i class="pi pi-palette text-primary"></i>
                            Variantes del Producto
                        </h4>

                        <!-- Add Variant Button -->
                        <div class="flex justify-content-between align-items-center mb-3">
                            <p class="text-sm text-600 m-0">Configura los colores, talles y stock disponibles</p>
                            <p-button label="Agregar Variante" icon="pi pi-plus" size="small" [outlined]="true" (onClick)="addVariant()" />
                        </div>

                        <!-- Variants List -->
                        <div formArrayName="variants" class="flex flex-column gap-3">
                            <div *ngFor="let variant of variantsArray.controls; let i = index" [formGroupName]="i" class="surface-100 p-3 border-round">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <h5 class="font-semibold m-0">Variante {{ i + 1 }}</h5>
                                    <p-button icon="pi pi-trash" size="small" severity="danger" [outlined]="true" [rounded]="true" (onClick)="removeVariant(i)" />
                                </div>

                                <!-- Color and Image -->
                                <div class="grid mb-3">
                                    <div class="col-6">
                                        <label class="block mb-2 font-semibold">Color *</label>
                                        <p-inputgroup>
                                            <p-inputgroup-addon>
                                                <i class="pi pi-palette"></i>
                                            </p-inputgroup-addon>
                                            <p-select [formControlName]="'color'" [options]="availableColors" optionLabel="label" optionValue="value" placeholder="Seleccionar color"
                                                class="w-full" appendTo="body" />
                                        </p-inputgroup>
                                    </div>
                                    <div class="col-6">
                                        <label class="block mb-2 font-semibold">Imagen de Variante</label>
                                        <div class="flex flex-column gap-2">
                                            <!-- Show existing image if available -->
                                            <div *ngIf="getVariantImagePath(i) && !selectedVariantImageNames[i]" class="flex align-items-center gap-2 p-2 surface-100 border-round">
                                                <div class="flex align-items-center gap-2 flex-1">
                                                    <p-image [src]="getVariantImagePath(i)" [alt]="getFileNameFromPath(getVariantImagePath(i))"
                                                        imageClass="w-3rem h-3rem border-round object-cover" (onImageError)="onImageError($event, undefined)" />
                                                    <div class="flex flex-column gap-1 flex-1">
                                                        <span class="font-semibold text-xs">{{ getFileNameFromPath(getVariantImagePath(i)) }}</span>
                                                        <span class="text-xs text-600">Imagen existente</span>
                                                    </div>
                                                </div>
                                                <p-button icon="pi pi-trash" severity="danger" [outlined]="true" [rounded]="true" size="small" (onClick)="clearVariantImage(i)"
                                                    pTooltip="Eliminar imagen">
                                                </p-button>
                                            </div>

                                            <!-- File Upload for Variant with Preview -->
                                            <p-fileupload #variantFileUpload mode="advanced" name="variantImage" accept="image/*" [maxFileSize]="maxImageSize" [auto]="true"
                                                (onSelect)="onVariantImageUpload($event, i)" [showCancelButton]="false" [showUploadButton]="false" [multiple]="false" styleClass="w-full">
                                                <ng-template #empty>
                                                    <div class="flex flex-column align-items-center gap-2 p-3">
                                                        <i class="pi pi-image text-2xl text-300"></i>
                                                        <span class="text-600 text-sm">Seleccionar imagen</span>
                                                    </div>
                                                </ng-template>
                                                <ng-template #content let-files let-removeFileCallback="removeFileCallback">
                                                    <div *ngIf="files?.length > 0" class="flex flex-column gap-2">
                                                        <div *ngFor="let file of files; let j = index" class="flex align-items-center gap-2 p-2 surface-100 border-round">
                                                            <div class="flex align-items-center gap-2 flex-1">
                                                                <img *ngIf="file.objectURL" [src]="file.objectURL" [alt]="file.name" class="w-3rem h-3rem border-round object-cover" />
                                                                <div class="flex flex-column gap-1 flex-1">
                                                                    <span class="font-semibold text-xs">{{ file.name }}</span>
                                                                    <span class="text-xs text-600">{{ formatFileSize(file.size) }}</span>
                                                                </div>
                                                            </div>
                                                            <p-button icon="pi pi-trash" severity="danger" [outlined]="true" [rounded]="true" size="small" (onClick)="removeFileCallback(j)"
                                                                pTooltip="Eliminar imagen">
                                                            </p-button>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </p-fileupload>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sizes and Stock -->
                                <div class="mb-3">
                                    <div class="flex justify-content-between align-items-center mb-2">
                                        <label class="font-semibold">Talles y Stock</label>
                                        <p-button label="Agregar Talle" icon="pi pi-plus" size="small" [outlined]="true" (onClick)="addSizeToVariant(i)" />
                                    </div>

                                    <div [formArrayName]="'sizes'" class="flex flex-column gap-2">
                                        <div *ngFor="let sizeControl of getVariantSizes(i).controls; let j = index" [formGroupName]="j" class="flex align-items-center gap-2">
                                            <div class="flex-1">
                                                <p-select [formControlName]="'size'" [options]="availableSizes" optionLabel="label" optionValue="value" placeholder="Talle" class="w-full"
                                                    appendTo="body" />
                                            </div>
                                            <div class="flex-1">
                                                <p-inputnumber [formControlName]="'stock'" [min]="0" placeholder="Stock" class="w-full" [showButtons]="true" />
                                            </div>
                                            <p-button icon="pi pi-trash" size="small" severity="danger" [outlined]="true" [rounded]="true" (onClick)="removeSizeFromVariant(i, j)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- No Variants Message -->
                        <div *ngIf="variantsArray.length === 0" class="text-center py-4">
                            <i class="pi pi-palette text-4xl text-300 mb-2 block"></i>
                            <p class="text-500 mb-3">No hay variantes configuradas</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="col-12">
                    <label for="productTags" class="block mb-2 font-semibold">Etiquetas</label>
                    <p-inputgroup>
                        <p-inputgroup-addon>
                            <i class="pi pi-tags"></i>
                        </p-inputgroup-addon>
                        <p-multiselect id="productTags" formControlName="tags" [options]="availableProductTags" optionLabel="label" optionValue="value" placeholder="Seleccionar etiquetas"
                            class="w-full" appendTo="body" [showToggleAll]="true" [maxSelectedLabels]="3" selectedItemsLabel="{0} elementos seleccionados"></p-multiselect>
                    </p-inputgroup>
                    <app-error-helper [control]="productForm.get('tags')"></app-error-helper>
                </div>
            </div>

            <div class="grid">
                <div class="col-6">
                    <div class="flex align-items-center gap-2">
                        <p-checkbox id="productIsNew" formControlName="isNew" [binary]="true"></p-checkbox>
                        <label for="productIsNew" class="cursor-pointer">Producto Nuevo</label>
                    </div>
                </div>
                <div class="col-6">
                    <div class="flex align-items-center gap-2">
                        <p-checkbox id="productIsFeatured" formControlName="isFeatured" [binary]="true"></p-checkbox>
                        <label for="productIsFeatured" class="cursor-pointer">Producto Destacado</label>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <ng-template #footer>
        <div class="flex justify-content-end gap-2 mt-2">
            <p-button label="Cancelar" (onClick)="showProductDialog = false" [outlined]="true" [rounded]="true" [disabled]="savingProduct"></p-button>
            <p-button [label]="editingProduct ? 'Actualizar' : 'Guardar'" (onClick)="saveProduct()" [disabled]="productForm.invalid || savingProduct" [rounded]="true"
                [loading]="savingProduct">
            </p-button>
        </div>
    </ng-template>
</p-dialog>