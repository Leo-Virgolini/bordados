<p-card class="border-round-xl shadow-3 p-3">
    <ng-template #header>
        <div class="flex justify-content-between align-items-center">
            <h2 class="text-xl font-bold m-0">
                <i class="pi pi-box mr-2"></i>Gesti칩n de Productos Personalizables
            </h2>
            <p-button label="Nuevo Producto" icon="pi pi-plus" [raised]="true" (onClick)="openProductDialog()" />
        </div>
    </ng-template>

    <p-table [value]="customizableProducts" [paginator]="true" [rows]="10" [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
        [rowsPerPageOptions]="[5, 10, 25]" styleClass="p-datatable-sm">

        <ng-template #header>
            <tr>
                <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
                <th pSortableColumn="name">Nombre <p-sortIcon field="name"></p-sortIcon></th>
                <th>Imagen</th>
                <th pSortableColumn="price">Precio Base <p-sortIcon field="price"></p-sortIcon></th>
                <th>Variantes y Stock por Talle</th>
                <th>Acciones</th>
            </tr>
        </ng-template>

        <ng-template #body let-product>
            <tr>
                <td>
                    <span class="font-bold text-primary">{{ product.id }}</span>
                </td>
                <td>
                    <div class="flex flex-column align-items-start">
                        <span class="font-semibold">{{ product.name }}</span>
                        <span class="text-sm text-600">{{ product.description }}</span>
                        <p-tag [value]="product.garmentType" severity="info" [rounded]="true" size="small"></p-tag>
                    </div>
                </td>
                <td>
                    <p-image [src]="getProductImage(product)" alt="{{ product.name }}" width="120" imageClass="border-round" [preview]="true" />
                </td>
                <td>
                    <span class="font-semibold text-primary">{{ product.price | currency:'ARS':'symbol':'1.0-0' }}</span>
                </td>
                <td>
                    <div class="flex flex-column gap-2">
                        <div *ngFor="let variant of product.variants.slice(0, 3)" class="flex flex-column gap-1">
                            <div class="flex align-items-center gap-2">
                                <div class="w-1rem h-1rem border-circle border-1 border-gray-300" [style.background-color]="getColorValue(variant.color)"></div>
                                <span class="text-sm font-semibold">{{ variant.color }}</span>
                            </div>
                            <div class="flex flex-wrap gap-1 ml-3">
                                <span *ngFor="let size of variant.sizes" class="text-xs bg-primary-50 text-primary-700 px-2 py-1 border-round">
                                    {{ size.size }}: {{ size.stock }}
                                </span>
                            </div>
                        </div>
                        <p-tag *ngIf="product.variants.length > 3" [value]="'+' + (product.variants.length - 3) + ' m치s'" severity="secondary" [rounded]="true" size="small"></p-tag>
                    </div>
                </td>
                <td>
                    <div class="flex gap-2">
                        <p-button icon="pi pi-pencil" [outlined]="true" size="small" (onClick)="openProductDialog(product)" />
                        <p-button icon="pi pi-trash" [outlined]="true" severity="danger" size="small" (onClick)="deleteProduct(product)" />
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-card>

<!-- Product Dialog -->
<p-dialog [(visible)]="showProductDialog" modal="true" styleClass="w-full md:w-9" [draggable]="false" [resizable]="false" [closable]="true"
    [header]="editingProduct ? 'Editar Producto Personalizable' : 'Nuevo Producto Personalizable'" (onHide)="showProductDialog = false">

    <form [formGroup]="productForm" class="flex flex-column gap-4">
        <!-- Basic Information -->
        <div class="grid">
            <div class="col-12 md:col-6">
                <label for="productId" class="block mb-2 font-semibold">ID del Producto *</label>
                <p-inputgroup>
                    <p-inputgroup-addon>
                        <i class="pi pi-box"></i>
                    </p-inputgroup-addon>
                    <input id="productId" type="text" pInputText formControlName="id" class="w-full" placeholder="Ej: CUST-001" />
                </p-inputgroup>
                <app-error-helper [control]="productForm.get('id')"></app-error-helper>
            </div>

            <div class="col-12 md:col-6">
                <label for="productName" class="block mb-2 font-semibold">Nombre *</label>
                <p-inputgroup>
                    <p-inputgroup-addon>
                        <i class="pi pi-tag"></i>
                    </p-inputgroup-addon>
                    <input id="productName" type="text" pInputText formControlName="name" class="w-full" placeholder="Ej: Remera Personalizable" />
                </p-inputgroup>
                <app-error-helper [control]="productForm.get('name')"></app-error-helper>
            </div>
        </div>

        <div class="grid">
            <div class="col-12 md:col-6">
                <label for="productDescription" class="block mb-2 font-semibold">Descripci칩n *</label>
                <textarea id="productDescription" pTextarea formControlName="description" rows="3" class="w-full" placeholder="Descripci칩n del producto personalizable"></textarea>
                <app-error-helper [control]="productForm.get('description')"></app-error-helper>
            </div>

            <div class="col-12 md:col-6">
                <label for="productGarmentType" class="block mb-2 font-semibold">Tipo de Prenda *</label>
                <p-select id="productGarmentType" formControlName="garmentType" [options]="garmentTypes" optionLabel="label" optionValue="value" placeholder="Seleccionar tipo de prenda"
                    class="w-full" />
                <app-error-helper [control]="productForm.get('garmentType')"></app-error-helper>
            </div>
        </div>

        <div class="grid">
            <div class="col-12 md:col-6">
                <label for="productPrice" class="block mb-2 font-semibold">Precio Base *</label>
                <p-inputgroup>
                    <p-inputgroup-addon>
                        <i class="pi pi-dollar"></i>
                    </p-inputgroup-addon>
                    <p-inputnumber id="productPrice" formControlName="price" class="w-full" placeholder="0" [min]="0" [max]="999999" mode="currency" currency="ARS" />
                </p-inputgroup>
                <app-error-helper [control]="productForm.get('price')"></app-error-helper>
            </div>
        </div>

        <!-- Variants Section -->
        <div class="grid">
            <div class="col-12">
                <div class="surface-50 p-3 border-round">
                    <h4 class="font-semibold mb-3 flex align-items-center gap-2">
                        <i class="pi pi-palette text-primary"></i>
                        Variantes del Producto
                    </h4>

                    <!-- Add Variant Button -->
                    <div class="flex justify-content-between align-items-center mb-3">
                        <p class="text-sm text-600 m-0">Configura los colores, talles y stock disponibles</p>
                        <p-button label="Agregar Variante" icon="pi pi-plus" size="small" [outlined]="true" (onClick)="addVariant()" />
                    </div>

                    <!-- Variants List -->
                    <div formArrayName="variants" class="flex flex-column gap-3">
                        <div *ngFor="let variant of variantsArray.controls; let i = index" [formGroupName]="i" class="surface-100 p-3 border-round">
                            <div class="flex justify-content-between align-items-center mb-2">
                                <h5 class="font-semibold m-0">Variante {{ i + 1 }}</h5>
                                <p-button icon="pi pi-trash" size="small" severity="danger" [outlined]="true" [rounded]="true" (onClick)="removeVariant(i)" />
                            </div>

                            <!-- Color and Image -->
                            <div class="grid mb-3">
                                <div class="col-6">
                                    <label class="block mb-2 font-semibold">Color *</label>
                                    <p-inputgroup>
                                        <p-inputgroup-addon>
                                            <i class="pi pi-palette"></i>
                                        </p-inputgroup-addon>
                                        <p-select [formControlName]="'color'" [options]="availableColors" optionLabel="label" optionValue="value" placeholder="Seleccionar color"
                                            class="w-full" appendTo="body" />
                                    </p-inputgroup>
                                </div>
                                <div class="col-6">
                                    <label class="block mb-2 font-semibold">URL de Imagen</label>
                                    <p-inputgroup>
                                        <p-inputgroup-addon>
                                            <i class="pi pi-image"></i>
                                        </p-inputgroup-addon>
                                        <input type="text" pInputText [formControlName]="'image'" class="w-full" placeholder="https://ejemplo.com/imagen.jpg" />
                                    </p-inputgroup>
                                </div>
                            </div>

                            <!-- Sizes and Stock -->
                            <div class="mb-3">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <label class="font-semibold">Talles y Stock</label>
                                    <p-button label="Agregar Talle" icon="pi pi-plus" size="small" [outlined]="true" (onClick)="addSizeToVariant(i)" />
                                </div>

                                <div [formArrayName]="'sizes'" class="flex flex-column gap-2">
                                    <div *ngFor="let sizeControl of getVariantSizes(i).controls; let j = index" [formGroupName]="j" class="flex align-items-center gap-2">
                                        <div class="col-4">
                                            <p-select [formControl]="getSizeControl(i, j)" [options]="availableSizes" optionLabel="label" optionValue="value" placeholder="Talle"
                                                class="w-full" />
                                        </div>
                                        <div class="col-4">
                                            <p-inputnumber [formControl]="getStockControl(i, j)" [min]="0" [showButtons]="true" buttonLayout="horizontal" spinnerMode="horizontal"
                                                [step]="1" placeholder="Stock" class="w-full" />
                                        </div>
                                        <div class="col-2">
                                            <p-button icon="pi pi-trash" size="small" severity="danger" [outlined]="true" [rounded]="true" (onClick)="removeSizeFromVariant(i, j)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <ng-template #footer>
        <div class="flex justify-content-end gap-2 mt-3">
            <p-button label="Cancelar" icon="pi pi-times" [outlined]="true" (onClick)="showProductDialog = false" [disabled]="productLoading" />
            <p-button label="Guardar" icon="pi pi-check" (onClick)="saveProduct()" [disabled]="!productForm.valid || productLoading" [loading]="productLoading" />
        </div>
    </ng-template>
</p-dialog>