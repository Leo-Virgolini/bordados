<p-toast position="bottom-center">
</p-toast>
<app-spinner [visible]="isLoading || isLoadingProducts"></app-spinner>

<main class="surface-ground p-3">
    <!-- Return Button inside the section, above the panel -->
    <div class="mb-4">
        <p-button label="Volver al Inicio" icon="pi pi-home" routerLink="/" [outlined]="true" [rounded]="true" severity="primary" />
    </div>
    <div class="grid">
        <!-- Form Section -->
        <section class="col-12 md:col-8">
            <p-panel styleClass="border-round-xl shadow-3 bg-surface-0 p-3">
                <ng-template #header>
                    <h1 class="text-3xl font-bold mt-0 flex align-items-center justify-content-center text-center"><i class="pi pi-pencil mr-2" style="font-size: 1.5rem"></i> Personalizá
                        tu prenda</h1>
                </ng-template>

                <form [formGroup]="formulario" class="p-fluid flex flex-column gap-4 max-w-2xl mx-auto" [class.opacity-50]="isLoadingProducts">
                    <!-- Tipo de prenda -->
                    <div>
                        <label for="tipo" class="block mb-2 text-lg font-semibold">Seleccione prenda: *</label>
                        <p-selectbutton id="tipo" formControlName="tipo" class="w-auto" size="large" [options]="availableTypes" optionLabel="label" optionValue="value"
                            aria-labelledby="basic" required (onChange)="onTipoPrendaChange()" [disabled]="isLoadingProducts">
                            <ng-template #item let-type>
                                <ng-container>
                                    <p-image [src]="type.product.variants[0]?.image" imageClass="w-full border-round-xl border-500 border-1" [pTooltip]="type.label"
                                        tooltipPosition="top" />
                                    <p-badge *ngIf="type.product.price" [value]="(type.product.price | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" badgeSize="xlarge"
                                        class="absolute top-0 right-0 m-2" />
                                </ng-container>
                            </ng-template>
                        </p-selectbutton>
                        <app-error-helper [control]="formulario.get('tipo')"></app-error-helper>
                    </div>

                    <!-- Color de prenda -->
                    <div *ngIf="formulario.get('tipo')?.value">
                        <label for="colorPrenda" class="block mb-2 text-lg font-semibold">Color de la prenda: *</label>
                        <p-selectbutton id="colorPrenda" [options]="availableColors" class="w-full max-w-fit" formControlName="colorPrenda" size="large" optionLabel="label"
                            optionValue="value" aria-labelledby="basic" required (onChange)="onColorPrendaChange()">
                            <ng-template #item let-color>
                                <div class="border-circle border-1 border-300 w-2rem h-2rem" [pTooltip]="color.label" tooltipPosition="top"
                                    [ngStyle]="{'background-color': getColorValue(color.label), 'background-image': 'repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0px, rgba(255, 255, 255, 0.1) 1px, transparent 1px, transparent 4px)'}">
                                </div>
                            </ng-template>
                        </p-selectbutton>
                        <app-error-helper [control]="formulario.get('colorPrenda')"></app-error-helper>
                    </div>

                    <!-- Talle -->
                    <div *ngIf="formulario.get('tipo')?.value && formulario.get('colorPrenda')?.value">
                        <label for="talle" class="block mb-2 text-lg font-semibold">Talle: *</label>
                        <div class="flex align-items-center gap-3">
                            <p-selectbutton id="talle" [options]="availableSizes" class="w-auto" formControlName="talle" size="large" optionLabel="label" optionValue="value"
                                aria-labelledby="basic" required (onChange)="onTalleChange()" />
                            <p-button label="Guía de Talles" icon="pi pi-tags" severity="info" [rounded]="true" [raised]="true" size="small" (onClick)="openSizeGuide()" />
                        </div>
                        <app-error-helper [control]="formulario.get('talle')"></app-error-helper>
                    </div>

                    <!-- 1° Color del hilado -->
                    <div>
                        <label for="colorHilado1" class="block mb-2 text-lg font-semibold">Color del hilado: *</label>
                        <p-selectbutton id="colorHilado1" [options]="coloresHilado" class="w-full max-w-fit" formControlName="colorHilado1" size="large" optionLabel="name" optionValue="id"
                            aria-labelledby="basic" required>
                            <ng-template #item let-color>
                                <div class="border-circle border-1 border-300 w-2rem h-2rem" [pTooltip]="color.name" tooltipPosition="top"
                                    [ngStyle]="{'background-color': color.code, 'background-image': 'repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0px, rgba(255, 255, 255, 0.1) 1px, transparent 1px, transparent 4px)'}">
                                </div>
                            </ng-template>
                        </p-selectbutton>
                        <app-error-helper [control]="formulario.get('colorHilado1')"></app-error-helper>
                    </div>

                    <!-- ¿Usar un segundo color? -->
                    <div>
                        <label for="usarSegundoColor" class="block mb-2 text-lg font-semibold">¿Querés usar un segundo color de hilado?
                            <p-badge value="Opcional" severity="warn" class="ml-2" />
                        </label>
                        <p-togglebutton id="usarSegundoColor" formControlName="usarSegundoColor" onLabel="Sí" offLabel="No" onIcon="pi pi-check" offIcon="pi pi-times" size="large"
                            aria-label="Confirmation" (onChange)="onUsarSegundoColorChange()"></p-togglebutton>
                        <p-badge *ngIf="formulario.get('usarSegundoColor')?.value" value="+{{ precioSegundoColor | currency:'ARS':'symbol':'1.0-0' }}" severity="success" badgeSize="large"
                            class="ml-2" />
                    </div>

                    <!-- 2° Color del hilado (Opcional) -->
                    <div *ngIf="formulario.get('usarSegundoColor')?.value">
                        <label for="colorHilado2" class="block mb-2 text-lg font-semibold">Segundo color del hilado: *</label>
                        <p-selectbutton id="colorHilado2" [options]="coloresHilado" formControlName="colorHilado2" size="large" class="w-full max-w-fit" optionLabel="name" optionValue="id"
                            aria-labelledby="basic">
                            <ng-template #item let-color>
                                <div class="border-circle border-1 border-300 w-2rem h-2rem" [pTooltip]="color.name" tooltipPosition="top"
                                    [ngStyle]="{'background-color': color.code, 'background-image': 'repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0px, rgba(255, 255, 255, 0.1) 1px, transparent 1px, transparent 4px)'}">
                                </div>
                            </ng-template>
                        </p-selectbutton>
                        <app-error-helper [control]="formulario.get('colorHilado2')"></app-error-helper>
                    </div>

                    <!-- ¿Usar texto personalizado? -->
                    <div>
                        <label for="usarTextoPersonalizado" class="block mb-2 text-lg font-semibold">¿Querés agregar texto personalizado debajo de la imagen?
                            <p-badge value="Opcional" severity="warn" class="ml-2" />
                        </label>
                        <p-togglebutton id="usarTextoPersonalizado" formControlName="usarTextoPersonalizado" onLabel="Sí" offLabel="No" onIcon="pi pi-check" offIcon="pi pi-times"
                            size="large" aria-label="Texto personalizado" (onChange)="onUsarTextoPersonalizadoChange()"></p-togglebutton>
                        <p-badge *ngIf="formulario.get('usarTextoPersonalizado')?.value" value="+{{ precioTextoPersonalizado | currency:'ARS':'symbol':'1.0-0' }}" severity="success"
                            badgeSize="large" class="ml-2" />
                    </div>

                    <!-- Texto personalizado (Opcional) -->
                    <div *ngIf="formulario.get('usarTextoPersonalizado')?.value">
                        <label for="textoPersonalizado" class="block mb-2 text-lg font-semibold">Texto personalizado: *</label>
                        <p-inputgroup class="max-w-max">
                            <p-inputgroup-addon>
                                <i class="pi pi-language"></i>
                            </p-inputgroup-addon>
                            <input pInputText id="textoPersonalizado" formControlName="textoPersonalizado" class="w-full" placeholder="Ej: Mi nombre, fecha, etc."
                                [maxlength]="maxTextLength" />
                            <p-inputgroup-addon *ngIf="formulario.get('colorTextoPersonalizado')?.value" class="p-0">
                                <div class="w-2rem h-2rem border-circle border-1 border-300 flex align-items-center justify-content-center"
                                    [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorTextoPersonalizado')?.value)}">
                                    <i class="pi pi-palette  text-sm"></i>
                                </div>
                            </p-inputgroup-addon>
                        </p-inputgroup>
                        <app-error-helper [control]="formulario.get('textoPersonalizado')"></app-error-helper>
                        <div class="flex justify-content-start align-items-center mt-2">
                            <small class="text-500">Máximo {{ maxTextLength }} caracteres ({{ (formulario.get('textoPersonalizado')?.value?.length || 0) }}/{{ maxTextLength }})</small>
                        </div>
                    </div>

                    <!-- Color del texto personalizado (Opcional) -->
                    <div *ngIf="formulario.get('usarTextoPersonalizado')?.value">
                        <label for="colorTextoPersonalizado" class="block mb-2 text-lg font-semibold">Color del texto: *</label>
                        <p-selectButton id="colorTextoPersonalizado" formControlName="colorTextoPersonalizado" [options]="coloresHilado" optionLabel="name" optionValue="id"
                            class="w-full max-w-fit" [disabled]="!formulario.get('usarTextoPersonalizado')?.value">
                            <ng-template #item let-color>
                                <div class="border-circle border-1 border-300 w-2rem h-2rem" [pTooltip]="color.name" tooltipPosition="top"
                                    [ngStyle]="{'background-color': color.code, 'background-image': 'repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0px, rgba(255, 255, 255, 0.1) 1px, transparent 1px, transparent 4px)'}">
                                </div>
                            </ng-template>
                        </p-selectButton>
                        <app-error-helper [control]="formulario.get('colorTextoPersonalizado')"></app-error-helper>
                    </div>

                    <!-- Imagen -->
                    <div>
                        <label for="imagen" class="block mb-2 text-lg font-semibold">Imagen: *</label>
                        <p-fileupload id="imagen" name="imagen" mode="advanced" accept="image/*" [maxFileSize]="maxImageSize" (onSelect)="onImageSelect($event)" [multiple]="false"
                            [auto]="false" required>
                            <ng-template #header let-chooseCallback="chooseCallback">
                                <div class="flex flex-wrap justify-between items-center flex-1 gap-4">
                                    <div class="flex gap-2">
                                        <p-button (onClick)="elegirImagen($event, chooseCallback)" label="Seleccionar" icon="pi pi-images text-4xl" size="large" [raised]="true"
                                            [outlined]="true" />
                                    </div>
                                    <!-- <p-progressbar *ngIf="image" [value]="totalSizePercent" [showValue]="true" class="w-full" styleClass="md:w-20rem h-1 w-full md:ml-auto">
                                    <span class="whitespace-nowrap">{{ image?.bytes }}B / 1Mb</span>
                                    </p-progressbar> -->
                                </div>
                            </ng-template>

                            <ng-template #content let-removeFileCallback="removeFileCallback">
                                <div *ngIf="imageFile" class="flex align-items-center gap-3">
                                    <p-image [alt]="imageFile.name" [src]="imageURL" width="120" preview />
                                    <span class="font-semibold text-ellipsis max-w-60 whitespace-nowrap overflow-hidden">
                                        {{ imageFile.name }} - {{ formatSize(imageFile.size) }}
                                    </span>
                                    <p-button icon="pi pi-trash" (onClick)="eliminarImagen($event, removeFileCallback)" [rounded]="true" severity="danger" />
                                </div>
                            </ng-template>

                            <ng-template #file></ng-template>

                            <ng-template #empty>
                                <p-divider />
                                <div class="flex flex-row align-items-center justify-content-center">
                                    <i class="pi pi-cloud-upload text-4xl text-primary mr-3"></i>
                                    <p class="text-lg">
                                        Arrastrá y soltá acá la imagen.<br />(Tamaño máximo {{ formatSize(maxImageSize) }})
                                    </p>
                                </div>
                            </ng-template>
                        </p-fileupload>
                        <app-error-helper [control]="formulario.get('imagen')"></app-error-helper>
                    </div>

                    <!-- Cantidad -->
                    <div *ngIf="formulario.get('talle')?.value" class="flex flex-column gap-1">
                        <div class="flex align-items-center gap-2 mb-1">
                            <label for="cantidad" class="block text-lg font-semibold mb-0">Cantidad: *</label>
                            <p-badge [value]="'Stock disponible: ' + getCurrentStock()" severity="warn" badgeSize="large" styleClass="ml-1" [pTooltip]="'Stock disponible'"
                                tooltipPosition="top"></p-badge>
                        </div>
                        <p-inputgroup class="max-w-max">
                            <p-inputgroup-addon>
                                <i class="pi pi-box"></i>
                            </p-inputgroup-addon>
                            <p-inputnumber id="cantidad" formControlName="cantidad" [min]="1" [max]="getCurrentStock()" [showButtons]="true" buttonLayout="horizontal"
                                spinnerMode="horizontal" [step]="1" class="w-auto" placeholder="1" />
                        </p-inputgroup>
                        <app-error-helper [control]="formulario.get('cantidad')"></app-error-helper>
                    </div>

                </form>
            </p-panel>
        </section>

        <!-- Panel Resumen -->
        <aside class="col-12 md:col-4">
            <div class="sticky" style="top: 7rem;">
                <p-panel styleClass="border-round-xl shadow-3 bg-surface-0 p-3">
                    <ng-template #header>
                        <div class="flex align-items-center justify-content-center gap-2">
                            <i class="pi pi-receipt text-primary" style="font-size: 1.5rem"></i>
                            <h1 class="text-2xl font-bold mt-0 mb-0 text-center">Resumen del Pedido</h1>
                        </div>
                    </ng-template>

                    <div class="flex flex-column gap-4">
                        <!-- Product Selection -->
                        <div *ngIf="formulario.get('tipo')?.value" class="surface-50 border-round-lg p-3">
                            <h3 class="text-lg font-semibold text-900 mb-3 flex align-items-center gap-2 mt-0">
                                <i class="pi pi-ticket text-primary text-lg"></i>
                                <span class="font-semibold text-900">Producto Seleccionado</span>
                            </h3>
                            <div class="flex align-items-center justify-content-between mb-2">
                                <div class="flex align-items-center gap-2">
                                    <i class="pi pi-chevron-right text-primary"></i>
                                    <span>{{ getLabel('tipo', availableTypes) }}</span>
                                </div>
                                <p-badge [value]="(getPrecio('tipo', availableTypes) | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" badgeSize="large" />
                            </div>
                        </div>

                        <!-- Specifications -->
                        <div class="surface-50 border-round-lg p-3">
                            <h3 class="text-lg font-semibold text-900 mb-3 flex align-items-center gap-2 mt-0">
                                <i class="pi pi-cog text-primary"></i>
                                Especificaciones
                            </h3>

                            <div class="flex flex-column gap-3">
                                <!-- Color de prenda -->
                                <div *ngIf="formulario.get('colorPrenda')?.value" class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-palette text-blue-500"></i>
                                        <span class="text-600">Color de prenda</span>
                                    </div>
                                    <div class="flex align-items-center gap-2">
                                        <div class="w-1rem h-1rem border-circle border-1 border-300"
                                            [ngStyle]="{'background-color': getColorValue(getLabel('colorPrenda', availableColors))}"></div>
                                        <span class="font-semibold text-900">{{ getLabel('colorPrenda', availableColors) }}</span>
                                    </div>
                                </div>

                                <!-- Talle -->
                                <div *ngIf="formulario.get('talle')?.value" class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-tag text-green-500"></i>
                                        <span class="text-600">Talle</span>
                                    </div>
                                    <span class="font-semibold text-900">{{ getLabel('talle', availableSizes) }}</span>
                                </div>

                                <!-- Cantidad -->
                                <div *ngIf="formulario.get('talle')?.value && formulario.get('cantidad')?.value" class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-box text-orange-500"></i>
                                        <span class="text-600">Cantidad</span>
                                    </div>
                                    <span class="font-semibold text-900">{{ formulario.get('cantidad')?.value }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Thread Colors -->
                        <div class="surface-50 border-round-lg p-3">
                            <h3 class="text-lg font-semibold text-900 mb-3 flex align-items-center gap-2 mt-0">
                                <i class="pi pi-palette text-purple-500"></i>
                                Colores de Hilado
                            </h3>

                            <div class="flex flex-column gap-3">
                                <!-- Primary thread color -->
                                <div *ngIf="formulario.get('colorHilado1')?.value" class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-chevron-right text-primary"></i>
                                        <span class="text-600">Color principal</span>
                                    </div>
                                    <div class="flex align-items-center gap-2">
                                        <div class="w-1rem h-1rem border-circle border-1 border-300"
                                            [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorHilado1')?.value)}"></div>
                                        <span class="font-semibold text-900">{{ getLabel('colorHilado1', coloresHilado) }}</span>
                                    </div>
                                </div>

                                <!-- Secondary thread color -->
                                <div *ngIf="formulario.get('usarSegundoColor')?.value && formulario.get('colorHilado2')?.value" class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-chevron-right text-primary"></i>
                                        <span class="text-600">Color secundario</span>
                                    </div>
                                    <div class="flex align-items-center gap-2">
                                        <div class="w-1rem h-1rem border-circle border-1 border-300"
                                            [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorHilado2')?.value)}"></div>
                                        <span class="font-semibold text-900">{{ getLabel('colorHilado2', coloresHilado) }}</span>
                                        <p-badge [value]="(precioSegundoColor | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" badgeSize="large" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Text -->
                        <div *ngIf="formulario.get('usarTextoPersonalizado')?.value" class="surface-50 border-round-lg p-3">
                            <h3 class="text-lg font-semibold text-900 mb-3 flex align-items-center gap-2 mt-0">
                                <i class="pi pi-align-center text-pink-500"></i>
                                Texto Personalizado
                            </h3>

                            <div class="flex flex-column gap-3">
                                <!-- Custom text content -->
                                <div class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-language text-primary"></i>
                                        <span class="text-600">Texto</span>
                                    </div>
                                    <span class="font-semibold text-900">"{{ formulario.get('textoPersonalizado')?.value }}"</span>
                                </div>

                                <!-- Custom text color -->
                                <div *ngIf="formulario.get('colorTextoPersonalizado')?.value" class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-palette text-primary"></i>
                                        <span class="text-600">Color del texto</span>
                                    </div>
                                    <div class="flex align-items-center gap-2">
                                        <div class="w-1rem h-1rem border-circle border-1 border-300"
                                            [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorTextoPersonalizado')?.value)}"></div>
                                        <span class="font-semibold text-900">{{ getLabel('colorTextoPersonalizado', coloresHilado) }}</span>
                                        <p-badge [value]="(precioTextoPersonalizado | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" badgeSize="large" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Image Preview -->
                        <div *ngIf="imageURL" class="surface-50 border-round-lg p-3">
                            <h3 class="text-lg font-semibold text-900 mb-3 flex align-items-center gap-2">
                                <i class="pi pi-image text-cyan-500"></i>
                                Imagen Subida
                            </h3>
                            <div class="flex justify-content-center">
                                <p-image [src]="imageURL" [alt]="imageFile?.name" width="300" imageClass="border-round border-1 border-200" [preview]="true" />
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-500">{{ imageFile?.name }}</small>
                            </div>
                        </div>

                        <!-- Price Summary -->
                        <div *ngIf="formulario.valid" class="surface-100 border-round-lg p-3">
                            <h3 class="text-lg font-semibold text-900 mb-3 flex align-items-center gap-2">
                                <i class="pi pi-dollar text-green-500"></i>
                                Resumen de Precios
                            </h3>

                            <div class="flex flex-column gap-2">
                                <div class="flex justify-content-between align-items-center">
                                    <span class="text-600">Precio base</span>
                                    <span class="font-semibold text-green-500">{{ getSelectedPrice() | currency:'ARS':'symbol':'1.0-0' }}</span>
                                </div>

                                <!-- Second color price -->
                                <div *ngIf="formulario.get('usarSegundoColor')?.value" class="flex justify-content-between align-items-center">
                                    <span class="text-600">Segundo color</span>
                                    <span class="font-semibold text-green-500">+{{ precioSegundoColor | currency:'ARS':'symbol':'1.0-0' }}</span>
                                </div>

                                <!-- Custom text price -->
                                <div *ngIf="formulario.get('usarTextoPersonalizado')?.value" class="flex justify-content-between align-items-center">
                                    <span class="text-600">Texto personalizado</span>
                                    <span class="font-semibold text-green-500">+{{ precioTextoPersonalizado | currency:'ARS':'symbol':'1.0-0' }}</span>
                                </div>

                                <p-divider></p-divider>
                                <div class="flex justify-content-between align-items-center">
                                    <span class="text-600">Precio unitario</span>
                                    <span class="font-semibold text-green-500">{{ calcularPrecioUnitario() | currency:'ARS':'symbol':'1.0-0' }}</span>
                                </div>
                                <div class="flex justify-content-between align-items-center">
                                    <span class="text-600">Cantidad</span>
                                    <span class="font-semibold text-green-500">x {{ formulario.get('cantidad')?.value }}</span>
                                </div>
                                <p-divider></p-divider>
                                <div class="flex justify-content-between align-items-center">
                                    <span class="text-xl font-bold text-900">Total</span>
                                    <span class="text-2xl font-bold text-green-600">{{ calcularSubtotal() | currency:'ARS':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Add to Cart Button -->
                        <div class="flex align-items-center justify-content-center mt-3">
                            <p-button [disabled]="!formulario.valid" [icon]="!formulario.valid ? 'pi pi-lock' : 'pi pi-cart-plus'" [raised]="true" size="large" (click)="confirmar()"
                                [loading]="isLoading" [label]="formulario.valid? 'Agregar al Carrito' : 'Selecciona todos los campos'"
                                [severity]="formulario.valid? 'success' : 'secondary'" class="w-full md:w-auto" />
                        </div>
                    </div>
                </p-panel>
            </div>
        </aside>
    </div>

    <!-- Size Guide Modal -->
    <p-dialog [(visible)]="showSizeGuide" [modal]="true" [closable]="true" [draggable]="false" [resizable]="false" [style]="{width: '90vw', maxWidth: '800px'}" closeOnEscape="true"
        dismissableMask="true" (onHide)="closeSizeGuide()">

        <div class="flex flex-column gap-2">
            <!-- Description -->
            <div class="text-center">
                <div class="flex align-items-center justify-content-center mb-2">
                    <i class="pi pi-tags text-4xl text-primary mr-2"></i>
                    <h3 class="text-xl font-bold mt-0 mb-0">{{ sizeGuide.title }}</h3>
                </div>
                <p class="text-color-secondary">{{ sizeGuide.description }}</p>
            </div>

            <!-- Instructions -->
            <div class="bg-surface-50 border-round p-3">
                <h4 class="font-bold mb-3 mt-0">Cómo medir:</h4>
                <ul class="list-none p-0 m-0">
                    <li *ngFor="let instruction of sizeGuide.instructions" class="flex align-items-center gap-2 mb-2">
                        <i class="pi pi-check-circle text-primary"></i>
                        <span>{{ instruction }}</span>
                    </li>
                </ul>
            </div>

            <!-- Size Table -->
            <p-table [value]="sizeGuide.measurements" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th class="text-center">Talle</th>
                        <th class="text-center">Ancho del Pecho</th>
                        <th class="text-center">Largo Total</th>
                        <th class="text-center">Ajuste</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-measurement>
                    <tr>
                        <td class="font-bold text-center">{{ measurement.size }}</td>
                        <td class="text-center">{{ measurement.chest }}</td>
                        <td class="text-center">{{ measurement.length }}</td>
                        <td class="text-center">
                            <p-tag [value]="measurement.fit" [severity]="measurement.fit === 'Ajustado' ? 'warn' : measurement.fit === 'Regular' ? 'success' : 'info'" [rounded]="true" />
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- Tips -->
            <div class="bg-blue-50 border-round p-4">
                <div class="mb-2">
                    <h4 class="font-bold mb-2 mt-0 text-blue-900 flex align-items-center">
                        <i class="pi pi-info-circle mr-2"></i>Consejos:
                    </h4>
                </div>
                <ul class="list-none p-0 m-0 text-blue-800">
                    <li class="flex align-items-center gap-2 mb-1">
                        <i class="pi pi-circle-fill text-xs"></i>
                        <span>Si estás entre dos talles, elegí el más grande</span>
                    </li>
                    <li class="flex align-items-center gap-2 mb-1">
                        <i class="pi pi-circle-fill text-xs"></i>
                        <span>Las prendas oversize tienen un ajuste más holgado</span>
                    </li>
                    <li class="flex align-items-center gap-2">
                        <i class="pi pi-circle-fill text-xs"></i>
                        <span>Para un ajuste más personalizado, contactanos</span>
                    </li>
                </ul>
            </div>
        </div>

        <ng-template #footer>
            <div class="flex justify-content-end gap-2">
                <p-button label="Cerrar" icon="pi pi-times" [outlined]="true" (onClick)="closeSizeGuide()" />
            </div>
        </ng-template>
    </p-dialog>

    <!-- Custom Confirmation Dialog -->
    <p-dialog [(visible)]="showConfirmationDialog" [modal]="true" [closable]="true" [draggable]="false" [resizable]="false" [style]="{width: '90vw', maxWidth: '600px'}"
        closeOnEscape="true" dismissableMask="true" header="Confirmar Pedido Personalizado" (onHide)="showConfirmationDialog = false">

        <div class="flex flex-column gap-3 p-3">
            <!-- Product Section -->
            <div class="surface-50 border-round p-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-ticket text-primary text-lg"></i>
                    <h4 class="font-bold m-0 text-primary">Producto</h4>
                </div>
                <div class="flex justify-content-between align-items-center">
                    <span class="font-semibold">{{ getLabel('tipo', availableTypes) }}</span>
                    <p-badge [value]="(getSelectedPrice() | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" />
                </div>
            </div>

            <!-- Specifications Section -->
            <div class="surface-50 border-round p-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-cog text-blue-500 text-lg"></i>
                    <h4 class="font-bold m-0 text-blue-500">Especificaciones</h4>
                </div>
                <div class="flex flex-column gap-2">
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-palette text-blue-500"></i>
                            <span>Color de prenda</span>
                        </div>
                        <div class="flex align-items-center gap-2">
                            <div class="w-1rem h-1rem border-circle border-1 border-300" [ngStyle]="{'background-color': getColorValue(getLabel('colorPrenda', availableColors))}"></div>
                            <span class="font-semibold">{{ getLabel('colorPrenda', availableColors) }}</span>
                        </div>
                    </div>
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-tag text-green-500"></i>
                            <span>Talle</span>
                        </div>
                        <span class="font-semibold">{{ getLabel('talle', availableSizes) }}</span>
                    </div>
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-box text-orange-500"></i>
                            <span>Cantidad</span>
                        </div>
                        <span class="font-semibold">{{ formulario.get('cantidad')?.value }}</span>
                    </div>
                </div>
            </div>

            <!-- Thread Colors Section -->
            <div class="surface-50 border-round p-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-palette text-purple-500 text-lg"></i>
                    <h4 class="font-bold m-0 text-purple-500">Colores de Hilado</h4>
                </div>
                <div class="flex flex-column gap-2">
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-chevron-right text-primary"></i>
                            <span>Color principal</span>
                        </div>
                        <div class="flex align-items-center gap-2">
                            <div class="w-1rem h-1rem border-circle border-1 border-300" [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorHilado1')?.value)}"></div>
                            <span class="font-semibold">{{ getLabel('colorHilado1', coloresHilado) }}</span>
                        </div>
                    </div>
                    <div *ngIf="formulario.get('usarSegundoColor')?.value" class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-chevron-right text-primary"></i>
                            <span>Color secundario</span>
                        </div>
                        <div class="flex align-items-center gap-2">
                            <div class="w-1rem h-1rem border-circle border-1 border-300" [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorHilado2')?.value)}"></div>
                            <span class="font-semibold">{{ getLabel('colorHilado2', coloresHilado) }}</span>
                            <p-badge [value]="(precioSegundoColor | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Text Section -->
            <div *ngIf="formulario.get('usarTextoPersonalizado')?.value" class="surface-50 border-round p-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-align-center text-pink-500 text-lg"></i>
                    <h4 class="font-bold m-0 text-pink-500">Texto Personalizado</h4>
                </div>
                <div class="flex flex-column gap-2">
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-language text-primary"></i>
                            <span>Texto</span>
                        </div>
                        <span class="font-semibold">"{{ formulario.get('textoPersonalizado')?.value }}"</span>
                    </div>
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-palette text-primary"></i>
                            <span>Color del texto</span>
                        </div>
                        <div class="flex align-items-center gap-2">
                            <div class="w-1rem h-1rem border-circle border-1 border-300"
                                [ngStyle]="{'background-color': getThreadColorCode(formulario.get('colorTextoPersonalizado')?.value)}"></div>
                            <span class="font-semibold">{{ getLabel('colorTextoPersonalizado', coloresHilado) }}</span>
                            <p-badge [value]="(precioTextoPersonalizado | currency:'ARS':'symbol':'1.0-0') || ''" severity="success" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Section -->
            <div class="surface-50 border-round p-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-image text-cyan-500 text-lg"></i>
                    <h4 class="font-bold m-0 text-cyan-500">Imagen</h4>
                </div>
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-file text-cyan-500"></i>
                    <span class="font-semibold">{{ imageFile?.name }}</span>
                </div>
            </div>

            <!-- Price Summary -->
            <div class="surface-100 border-round p-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-dollar text-green-500 text-lg"></i>
                    <h4 class="font-bold m-0 text-green-500">Resumen de Precios</h4>
                </div>
                <div class="flex flex-column gap-2">
                    <div class="flex justify-content-between align-items-center">
                        <span>Precio base</span>
                        <span class="font-semibold">{{ getSelectedPrice() | currency:'ARS':'symbol':'1.0-0' }}</span>
                    </div>
                    <div *ngIf="formulario.get('usarSegundoColor')?.value" class="flex justify-content-between align-items-center">
                        <span>Segundo color</span>
                        <span class="font-semibold">+{{ precioSegundoColor | currency:'ARS':'symbol':'1.0-0' }}</span>
                    </div>
                    <div *ngIf="formulario.get('usarTextoPersonalizado')?.value" class="flex justify-content-between align-items-center">
                        <span>Texto personalizado</span>
                        <span class="font-semibold">+{{ precioTextoPersonalizado | currency:'ARS':'symbol':'1.0-0' }}</span>
                    </div>
                    <p-divider></p-divider>
                    <div class="flex justify-content-between align-items-center">
                        <span>Precio unitario</span>
                        <span class="font-semibold">{{ calcularPrecioUnitario() | currency:'ARS':'symbol':'1.0-0' }}</span>
                    </div>
                    <div class="flex justify-content-between align-items-center">
                        <span>Cantidad</span>
                        <span class="font-semibold">x {{ formulario.get('cantidad')?.value }}</span>
                    </div>
                    <p-divider></p-divider>
                    <div class="flex justify-content-between align-items-center">
                        <span class="text-xl font-bold">Total</span>
                        <span class="text-2xl font-bold text-green-600">{{ calcularSubtotal() | currency:'ARS':'symbol':'1.0-0' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <ng-template #footer>
            <div class="flex justify-content-end gap-2 mt-3">
                <p-button label="Cancelar" icon="pi pi-times" [outlined]="true" (onClick)="showConfirmationDialog = false" />
                <p-button label="Confirmar" icon="pi pi-check" severity="success" (onClick)="confirmOrder()" [loading]="isLoading" />
            </div>
        </ng-template>
    </p-dialog>

</main>