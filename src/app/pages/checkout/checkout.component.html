<p-toast></p-toast>

<!-- Terms and Conditions Dialog -->
<p-dialog [(visible)]="showTermsDialog" modal="true" styleClass="w-full md:w-6 lg:w-5" dismissableMask="true" draggable="false" resizable="false" closable="true"
    header="Términos y Condiciones" (onHide)="closeTermsDialog()">

    <div class="max-h-30rem overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">Términos y Condiciones</h2>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">1. Aceptación de los Términos</h3>
            <p class="text-sm line-height-2">Al realizar una compra en nuestro sitio web, aceptás estos términos y condiciones en su totalidad. Si no estás de acuerdo con alguna parte de
                estos términos, no debés realizar una compra.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">2. Productos y Servicios</h3>
            <p class="text-sm line-height-2">Todos nuestros productos son bordados a mano con materiales de alta calidad. Los tiempos de entrega pueden variar según la complejidad del
                diseño y la disponibilidad de materiales.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">3. Precios y Pagos</h3>
            <p class="text-sm line-height-2">Todos los precios están expresados en pesos argentinos e incluyen IVA. Los pagos se procesan de forma segura a través de nuestros proveedores
                autorizados. Ofrecemos descuentos especiales para pagos por transferencia bancaria.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">4. Envíos y Entregas</h3>
            <p class="text-sm line-height-2">Realizamos envíos a todo el país a través de servicios de correo certificado. Los tiempos de entrega estimados son de 3-7 días hábiles para el
                interior del país y 1-3 días hábiles para CABA y GBA.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">5. Cambios y Devoluciones</h3>
            <p class="text-sm line-height-2">Aceptamos cambios y devoluciones dentro de los 30 días posteriores a la recepción del producto, siempre que el artículo esté en su estado
                original y sin usar. Los gastos de envío de devolución corren por cuenta del cliente.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">6. Garantía</h3>
            <p class="text-sm line-height-2">Todos nuestros productos tienen garantía de 6 meses por defectos de fabricación. La garantía no cubre el desgaste normal del uso ni daños
                causados por el cliente.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">7. Privacidad</h3>
            <p class="text-sm line-height-2">Tu información personal será tratada de acuerdo con nuestra política de privacidad. No compartimos tus datos con terceros sin tu consentimiento
                explícito.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">8. Contacto</h3>
            <p class="text-sm line-height-2">Para cualquier consulta sobre estos términos, podés contactarnos a través de nuestro formulario de contacto o por email a info@bordados.com.ar
            </p>
        </div>

        <div class="text-xs text-color-secondary mt-4">
            <p>Última actualización: {{ getCurrentDate() }}</p>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <p-button label="Cerrar" icon="pi pi-times" [outlined]="true" (onClick)="closeTermsDialog()" />
            <p-button label="Aceptar" icon="pi pi-check" (onClick)="closeTermsDialog()" styleClass="p-button-primary" />
        </div>
    </ng-template>
</p-dialog>

<!-- Privacy Policy Dialog -->
<p-dialog [(visible)]="showPrivacyDialog" modal="true" styleClass="w-full md:w-6 lg:w-5" dismissableMask="true" draggable="false" resizable="false" closable="true"
    header="Política de Privacidad" (onHide)="closePrivacyDialog()">

    <div class="max-h-30rem overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">Política de Privacidad</h2>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">1. Información que Recopilamos</h3>
            <p class="text-sm line-height-2">Recopilamos información que nos proporcionás directamente, como tu nombre, dirección de email, dirección postal, número de teléfono e
                información de pago cuando realizás una compra o te registrás en nuestro sitio web.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">2. Uso de la Información</h3>
            <p class="text-sm line-height-2">Utilizamos tu información personal para procesar pedidos, enviar confirmaciones, responder consultas, mejorar nuestros servicios y comunicarnos
                contigo sobre productos y ofertas que puedan interesarte.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">3. Compartir Información</h3>
            <p class="text-sm line-height-2">No vendemos, alquilamos ni compartimos tu información personal con terceros, excepto cuando es necesario para procesar tu pedido (proveedores
                de pago, servicios de envío) o cuando la ley lo requiera.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">4. Seguridad de Datos</h3>
            <p class="text-sm line-height-2">Implementamos medidas de seguridad técnicas y organizativas para proteger tu información personal contra acceso no autorizado, alteración,
                divulgación o destrucción. Utilizamos encriptación SSL para proteger los datos durante la transmisión.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">5. Cookies y Tecnologías Similares</h3>
            <p class="text-sm line-height-2">Utilizamos cookies y tecnologías similares para mejorar tu experiencia en nuestro sitio web, recordar tus preferencias y analizar el tráfico
                del sitio. Podés controlar el uso de cookies a través de la configuración de tu navegador.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">6. Tus Derechos</h3>
            <p class="text-sm line-height-2">Tenés derecho a acceder, corregir, actualizar o eliminar tu información personal. También podés optar por no recibir comunicaciones
                promocionales. Para ejercer estos derechos, contactanos a través de nuestro formulario de contacto.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">7. Retención de Datos</h3>
            <p class="text-sm line-height-2">Conservamos tu información personal durante el tiempo necesario para cumplir con los propósitos descritos en esta política, a menos que la ley
                requiera un período de retención más largo.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">8. Menores de Edad</h3>
            <p class="text-sm line-height-2">Nuestro sitio web no está dirigido a menores de 18 años. No recopilamos intencionalmente información personal de menores de edad. Si sos menor
                de edad, no debés proporcionarnos información personal sin el consentimiento de tus padres o tutores.</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">9. Cambios en la Política</h3>
            <p class="text-sm line-height-2">Podemos actualizar esta política de privacidad ocasionalmente. Te notificaremos sobre cualquier cambio significativo publicando la nueva
                política en nuestro sitio web y actualizando la fecha de "Última actualización".</p>
        </div>

        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">10. Contacto</h3>
            <p class="text-sm line-height-2">Si tenés preguntas sobre esta política de privacidad o sobre cómo manejamos tu información personal, contactanos a través de nuestro formulario
                de contacto o por email a privacidad@bordados.com.ar</p>
        </div>

        <div class="text-xs text-color-secondary mt-4">
            <p>Última actualización: {{ getCurrentDate() }}</p>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <p-button label="Cerrar" icon="pi pi-times" [outlined]="true" (onClick)="closePrivacyDialog()" />
            <p-button label="Aceptar" icon="pi pi-check" (onClick)="closePrivacyDialog()" severity="primary" />
        </div>
    </ng-template>
</p-dialog>
<main class="flex flex-column md:surface-ground p-3">
    <!-- Return to Cart Button -->
    <div>
        <p-button label="Volver al Carrito" icon="pi pi-arrow-left" routerLink="/carrito" [outlined]="true" [rounded]="true" severity="primary" />
    </div>
    <!-- Header -->
    <section class="text-center">
        <h1 class="flex align-items-center justify-content-center text-4xl font-bold text-primary-900 mb-2">
            <i class="pi pi-credit-card text-primary mr-3 text-4xl"></i>Finalizar Compra
        </h1>
        <p class="text-lg text-color-secondary">Completá tu información para finalizar el pedido</p>
    </section>

    <!-- Checkout Form -->
    <form [formGroup]="checkoutForm" class="grid">

        <section class="col-12 md:col-8">
            <p-panel class="border-round-xl shadow-3 bg-surface-0">
                <ng-template #header>
                    <h1 class="text-xl font-bold text-center flex justify-content-center align-items-center text-gray-700"><i class="pi pi-map-marker mr-2" style="font-size: 1.2rem"></i>
                        Información de Envío</h1>
                </ng-template>
                <div class="flex flex-column gap-4">
                    <div class="grid">
                        <!-- Name -->
                        <div class="col-12 md:col-4">
                            <label for="firstName" class="block mb-2 font-semibold">Nombre *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-user"></i>
                                </p-inputgroup-addon>
                                <input id="firstName" type="text" pInputText formControlName="firstName" class="w-full" placeholder="Tu nombre" autocomplete="given-name"
                                    [invalid]="checkoutForm.get('firstName')?.invalid && checkoutForm.get('firstName')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('firstName')"></app-error-helper>
                        </div>
                        <!-- Last Name -->
                        <div class="col-12 md:col-4">
                            <label for="lastName" class="block mb-2 font-semibold">Apellido *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-user"></i>
                                </p-inputgroup-addon>
                                <input id="lastName" type="text" pInputText formControlName="lastName" class="w-full" placeholder="Tu apellido" autocomplete="family-name"
                                    [invalid]="checkoutForm.get('lastName')?.invalid && checkoutForm.get('lastName')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('lastName')"></app-error-helper>
                        </div>
                        <!-- DNI -->
                        <div class="col-12 md:col-4">
                            <label for="dni" class="block mb-2 font-semibold">DNI *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-id-card"></i>
                                </p-inputgroup-addon>
                                <input id="dni" type="text" pInputText formControlName="dni" class="w-full" placeholder="12345678" maxlength="8" autocomplete="off"
                                    [invalid]="checkoutForm.get('dni')?.invalid && checkoutForm.get('dni')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('dni')"></app-error-helper>
                        </div>
                    </div>

                    <div class="grid">
                        <!-- Email -->
                        <div class="col-12 md:col-4">
                            <label for="email" class="block mb-2 font-semibold">Email *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-envelope"></i>
                                </p-inputgroup-addon>
                                <input id="email" type="email" pInputText formControlName="email" class="w-full" placeholder="tu@email.com" autocomplete="email"
                                    [invalid]="checkoutForm.get('email')?.invalid && checkoutForm.get('email')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('email')"></app-error-helper>
                        </div>
                        <!-- Phone -->
                        <div class="col-12 md:col-4">
                            <label for="phone" class="block mb-2 font-semibold">Teléfono *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-phone"></i>
                                </p-inputgroup-addon>
                                <p-inputmask id="phone" formControlName="phone" mask="99 9999-9999" placeholder="11 2345-6789" styleClass="w-full" autocomplete="tel"
                                    [invalid]="checkoutForm.get('phone')?.invalid && checkoutForm.get('phone')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('phone')"></app-error-helper>
                        </div>
                    </div>

                    <div class="grid">
                        <!-- Province -->
                        <div class="col-12 md:col-4">
                            <label for="provincia" class="block mb-2 font-semibold">Provincia *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-map-marker"></i>
                                </p-inputgroup-addon>
                                <p-select id="provincia" formControlName="provincia" [options]="provinces" optionLabel="label" optionValue="value" placeholder="Seleccioná tu provincia"
                                    class="w-full" autocomplete="address-level1" [invalid]="checkoutForm.get('provincia')?.invalid && checkoutForm.get('provincia')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('provincia')"></app-error-helper>
                        </div>
                        <!-- Localidad -->
                        <div class="col-12 md:col-4">
                            <label for="localidad" class="block mb-2 font-semibold">Localidad *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-map-marker"></i>
                                </p-inputgroup-addon>
                                <input id="localidad" type="text" pInputText formControlName="localidad" class="w-full" placeholder="Localidad" autocomplete="address-level2"
                                    [invalid]="checkoutForm.get('localidad')?.invalid && checkoutForm.get('localidad')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('localidad')"></app-error-helper>
                        </div>
                        <!-- Postal Code -->
                        <div class="col-12 md:col-4">
                            <label for="postalCode" class="block mb-2 font-semibold">Código Postal *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-map"></i>
                                </p-inputgroup-addon>
                                <input id="postalCode" type="text" pInputText formControlName="postalCode" class="w-full" placeholder="1234" maxlength="5" autocomplete="postal-code"
                                    [invalid]="checkoutForm.get('postalCode')?.invalid && checkoutForm.get('postalCode')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('postalCode')"></app-error-helper>
                        </div>
                    </div>

                    <div class="grid">
                        <!-- Address -->
                        <div class="col-12 md:col-4">
                            <label for="address" class="block mb-2 font-semibold">Dirección *</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-home"></i>
                                </p-inputgroup-addon>
                                <input id="address" type="text" pInputText formControlName="address" class="w-full" placeholder="Calle y número" autocomplete="street-address"
                                    [invalid]="checkoutForm.get('address')?.invalid && checkoutForm.get('address')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('address')"></app-error-helper>
                        </div>
                        <!-- Piso/Depto -->
                        <div class="col-12 md:col-4">
                            <label for="pisoDepto" class="block mb-2 font-semibold">Piso/Depto</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-building"></i>
                                </p-inputgroup-addon>
                                <input id="pisoDepto" type="text" pInputText formControlName="pisoDepto" class="w-full" placeholder="Piso 2, Depto A" autocomplete="off"
                                    [invalid]="checkoutForm.get('pisoDepto')?.invalid && checkoutForm.get('pisoDepto')?.touched" />
                            </p-inputgroup>
                            <app-error-helper [control]="checkoutForm.get('pisoDepto')"></app-error-helper>
                        </div>
                    </div>

                </div>
            </p-panel>

            <!-- Order Notes -->
            <!-- <p-panel class="border-round-xl shadow-3 bg-surface-0 mt-4">
                <ng-template #header>
                    <h1 class="text-xl font-bold text-center flex justify-content-center align-items-center text-gray-700"><i class="pi pi-comment mr-2" style="font-size: 1.2rem"></i>
                        Notas del Pedido</h1>
                </ng-template>
                <div class="flex flex-column gap-4">
                    <div class="grid">
                        <div class="col-12">
                            <label for="notes" class="block mb-2 font-semibold">Notas Adicionales</label>
                            <p-inputgroup>
                                <p-inputgroup-addon>
                                    <i class="pi pi-comment"></i>
                                </p-inputgroup-addon>
                                <textarea id="notes" pTextarea formControlName="notes" class="w-full"
                                    placeholder="Agregá cualquier instrucción especial, preferencia de color, o detalle adicional para tu pedido..." rows="3"></textarea>
                            </p-inputgroup>
                            <small class="text-color-secondary">Opcional: Podés agregar instrucciones especiales o detalles adicionales para tu pedido.</small>
                        </div>
                    </div>
                </div>
            </p-panel> -->

            <!-- Payment Method -->
            <p-panel class="border-round-xl shadow-3 bg-surface-0 mt-4">
                <ng-template #header>
                    <h1 class="text-xl font-bold text-center flex justify-content-center align-items-center text-gray-700"><i class="pi pi-wallet mr-2" style="font-size: 1.2rem"></i>
                        Método de Pago</h1>
                </ng-template>
                <div class="flex flex-column gap-4">
                    <div class="flex align-items-center gap-3">
                        <p-radiobutton name="selectedPaymentMethod" value="creditCard" formControlName="selectedPaymentMethod" inputId="creditCard" />
                        <label for="creditCard" class="flex align-items-center gap-2 cursor-pointer">
                            <i class="pi pi-credit-card text-primary text-xl"></i>
                            <span class="font-semibold">Tarjeta de Crédito</span>
                        </label>
                    </div>

                    <!-- Credit Card Form -->
                    <div *ngIf="checkoutForm.get('selectedPaymentMethod')?.value === 'creditCard'" class="border-1 border-round p-4 bg-surface-50">
                        <div class="grid">
                            <div class="col-12">
                                <label for="cardNumber" class="block mb-2 font-semibold">Número de Tarjeta *</label>
                                <p-inputgroup>
                                    <p-inputgroup-addon>
                                        <i class="pi pi-credit-card"></i>
                                    </p-inputgroup-addon>
                                    <p-inputmask id="cardNumber" formControlName="cardNumber" mask="9999 9999 9999 9999" placeholder="1234 5678 9012 3456" styleClass="w-full"
                                        autocomplete="cc-number" [invalid]="checkoutForm.get('cardNumber')?.invalid && checkoutForm.get('cardNumber')?.touched" />
                                </p-inputgroup>
                                <app-error-helper [control]="checkoutForm.get('cardNumber')"></app-error-helper>
                            </div>
                        </div>

                        <div class="grid mt-3">
                            <div class="col-12 md:col-6">
                                <label for="expiryDate" class="block mb-2 font-semibold">Fecha de Vencimiento *</label>
                                <p-inputgroup>
                                    <p-inputgroup-addon>
                                        <i class="pi pi-calendar"></i>
                                    </p-inputgroup-addon>
                                    <p-inputmask id="expiryDate" formControlName="expiryDate" mask="99/99" placeholder="MM/AA" styleClass="w-full" autocomplete="cc-exp"
                                        [invalid]="checkoutForm.get('expiryDate')?.invalid && checkoutForm.get('expiryDate')?.touched" />
                                </p-inputgroup>
                                <app-error-helper [control]="checkoutForm.get('expiryDate')"></app-error-helper>
                            </div>
                            <div class="col-12 md:col-6">
                                <label for="cvv" class="block mb-2 font-semibold">CVV *</label>
                                <p-inputgroup>
                                    <p-inputgroup-addon>
                                        <i class="pi pi-shield"></i>
                                    </p-inputgroup-addon>
                                    <input id="cvv" type="text" pInputText formControlName="cvv" class="w-full" placeholder="123" minlength="3" maxlength="4" autocomplete="cc-csc"
                                        [invalid]="checkoutForm.get('cvv')?.invalid && checkoutForm.get('cvv')?.touched" />
                                </p-inputgroup>
                                <app-error-helper [control]="checkoutForm.get('cvv')"></app-error-helper>
                            </div>
                        </div>

                        <div class="grid mt-3">
                            <div class="col-12">
                                <label for="cardholderName" class="block mb-2 font-semibold">Nombre del Titular *</label>
                                <p-inputgroup>
                                    <p-inputgroup-addon>
                                        <i class="pi pi-user"></i>
                                    </p-inputgroup-addon>
                                    <input id="cardholderName" type="text" pInputText formControlName="cardholderName" class="w-full" placeholder="Como aparece en la tarjeta"
                                        autocomplete="cc-name" [invalid]="checkoutForm.get('cardholderName')?.invalid && checkoutForm.get('cardholderName')?.touched" />
                                </p-inputgroup>
                                <app-error-helper [control]="checkoutForm.get('cardholderName')"></app-error-helper>
                            </div>
                        </div>
                    </div>

                    <div class="flex align-items-center gap-3">
                        <p-radiobutton name="selectedPaymentMethod" value="mercadopago" formControlName="selectedPaymentMethod" inputId="mercadopago" />
                        <label for="mercadopago" class="flex align-items-center gap-2 cursor-pointer">
                            <i class="pi pi-wallet text-blue-500 text-xl"></i>
                            <span class="font-semibold">MercadoPago</span>
                        </label>
                    </div>
                    <div *ngIf="checkoutForm.get('selectedPaymentMethod')?.value === 'mercadopago'">
                        <p-card>
                            <pre class="m-0 text-xl">{{ mercadopagoData }}</pre>
                        </p-card>
                    </div>

                    <div class="flex align-items-center gap-3">
                        <p-radiobutton name="selectedPaymentMethod" value="transfer" formControlName="selectedPaymentMethod" inputId="transfer" />
                        <label for="transfer" class="flex align-items-center gap-2 cursor-pointer">
                            <i class="pi pi-money-bill text-green-500 text-xl"></i>
                            <span class="font-semibold">Transferencia Bancaria</span>
                            <p-tag [value]="'- ' + cashDiscountPercentage * 100 + '%'" severity="success" class="font-semibold" [rounded]="true" style="margin-right: -0.5rem;" />
                        </label>
                    </div>
                    <div *ngIf="checkoutForm.get('selectedPaymentMethod')?.value === 'transfer'">
                        <p-card>
                            <pre class="m-0 text-xl">{{ transferData }}</pre>
                        </p-card>
                    </div>
                </div>
            </p-panel>

        </section>

        <!-- Order Summary -->
        <aside class="col-12 md:col-4">
            <div class="sticky" style="top: 7rem;">
                <p-panel class="border-round-2xl shadow-4 bg-surface-0">
                    <ng-template #header>
                        <div class="flex align-items-center justify-content-center p-3 border-surface-200">
                            <i class="pi pi-receipt text-primary text-2xl"></i>
                            <h2 class="text-xl font-bold text-900 m-0">Resumen del Pedido</h2>
                        </div>
                    </ng-template>

                    <div class="p-3">
                        <!-- Order Items -->
                        <div class="flex flex-column gap-3 mb-2">
                            <h3 class="text-lg font-semibold text-700 mb-3 mt-0">Productos</h3>

                            <div *ngFor="let item of cartItems; let last = last" class="flex align-items-start gap-3 p-3 border-round-xl surface-100 border-1 border-surface-200">

                                <!-- Product Image -->
                                <div class="flex-shrink-0">
                                    <p-image [src]="getProductImage(item.product)" [alt]="item.product.name"
                                        imageClass="w-4rem h-4rem object-cover border-round-lg border-1 border-surface-200" class="border-round-lg"
                                        (onImageError)="onImageError($event, item.product)" />
                                </div>

                                <!-- Product Details -->
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-900 text-sm line-height-2 mb-1">{{ item.product.name }}</div>

                                    <!-- Product Tags -->
                                    <div class="flex align-items-center gap-2 mb-2">
                                        <p-tag [value]="item.product.type === 'personalizable' ? 'Personalizable' : 'Bordado Listo'"
                                            [severity]="item.product.type === 'personalizable' ? 'warning' : 'success'" [rounded]="true" size="small" />
                                        <p-tag *ngIf="item.hasDiscount" [value]="'-' + item.discountPercentage + '%'" severity="danger" [rounded]="true" size="small" />
                                    </div>

                                    <!-- Quantity and Price -->
                                    <div class="flex align-items-center justify-content-between">
                                        <div class="text-xs text-600">
                                            Cantidad: <span class="font-semibold text-700">{{ item.quantity }}</span>
                                        </div>
                                        <div class="text-xs text-600">
                                            {{ item.unitPriceFormatted }} <span class="text-500">c/u</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Total Price -->
                                <div class="flex-shrink-0 text-right">
                                    <div class="font-bold text-primary text-lg">{{ item.total | currency:'ARS':'symbol':'1.0-0' }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Divider -->
                        <p-divider class="my-4"></p-divider>

                        <!-- Coupon Section -->
                        <div class="flex flex-column gap-3 mb-2">
                            <h3 class="text-lg font-semibold text-700 mb-3 mt-0">Cupón de Descuento</h3>

                            <div class="border-1 border-round-xl p-3 bg-surface-50">
                                <div class="flex align-items-center justify-content-between mb-3">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-ticket text-primary"></i>
                                        <span class="font-semibold text-700">Aplicar Cupón</span>
                                    </div>
                                    <p-button *ngIf="!selectedCoupon" [label]="showCouponInput ? 'Ocultar' : 'Agregar Cupón'" [icon]="showCouponInput ? 'pi pi-chevron-up' : 'pi pi-plus'"
                                        [outlined]="true" size="small" (onClick)="toggleCouponInput()" />
                                </div>

                                <div *ngIf="!selectedCoupon && showCouponInput" class="flex gap-2">
                                    <p-inputgroup class="flex-1">
                                        <p-inputgroup-addon>
                                            <i class="pi pi-ticket"></i>
                                        </p-inputgroup-addon>
                                        <input type="text" pInputText formControlName="couponCode" class="w-full" placeholder="Ingresá tu código"
                                            [invalid]="checkoutForm.get('couponCode')?.invalid && checkoutForm.get('couponCode')?.touched" />
                                    </p-inputgroup>
                                    <p-button icon="pi pi-check" (onClick)="validateAndApplyCoupon()" [loading]="couponLoading" [disabled]="!checkoutForm.get('couponCode')?.value"
                                        [outlined]="true" />
                                </div>

                                <div *ngIf="selectedCoupon" class="flex flex-column gap-2">
                                    <div class="flex align-items-center justify-content-between">
                                        <div class="flex align-items-center gap-2">
                                            <p-tag [value]="selectedCoupon.code" severity="success" [rounded]="true" />
                                            <span class="font-semibold text-green-600">
                                                {{ selectedCoupon.discountType === 'percentage' ? selectedCoupon.discountValue + '%' : '$' +
                                                selectedCoupon.discountValue.toLocaleString('es-AR') }}
                                            </span>
                                        </div>
                                        <p-button icon="pi pi-times" (onClick)="clearCoupon()" [outlined]="true" severity="danger" size="small" />
                                    </div>
                                    <div *ngIf="selectedCoupon.description" class="text-sm text-600">
                                        {{ selectedCoupon.description }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Price Breakdown -->
                        <div class="flex flex-column gap-3 mb-4">
                            <h3 class="text-lg font-semibold text-700 mb-3">Desglose de Precios</h3>

                            <!-- Subtotal -->
                            <div class="flex justify-content-between align-items-center p-3 surface-100 border-round-lg">
                                <div class="flex align-items-center gap-2">
                                    <i class="pi pi-shopping-bag text-primary"></i>
                                    <span class="text-700 font-medium">Subtotal ({{ cartItems.length }} item{{ cartItems.length > 1 ? 's' : '' }})</span>
                                </div>
                                <span class="font-semibold text-900">{{ subtotal | currency:'ARS':'symbol':'1.0-0' }}</span>
                            </div>

                            <!-- Precio sin IVA -->
                            <div class="flex justify-content-between align-items-center p-2">
                                <div class="flex align-items-center gap-2">
                                    <span class="text-600 text-sm">Precio sin IVA</span>
                                    <p-tag [value]="'- ' + (ivaPercentage * 100) + '%'" severity="warning" [rounded]="true" size="small" />
                                </div>
                                <span class="text-600 text-sm font-medium">{{ subtotal / (1 + ivaPercentage) | currency:'ARS':'symbol':'1.0-0' }}</span>
                            </div>

                            <!-- Transfer Discount -->
                            <div *ngIf="checkoutForm.get('selectedPaymentMethod')?.value === 'transfer'"
                                class="flex justify-content-between align-items-center p-3 surface-100 border-round-lg border-left-3 border-green-500">
                                <div class="flex align-items-center gap-2">
                                    <i class="pi pi-money-bill text-green-600"></i>
                                    <span class="text-700 font-medium">Descuento por transferencia</span>
                                    <p-tag [value]="'- ' + (cashDiscountPercentage * 100) + '%'" severity="success" [rounded]="true" size="small" />
                                </div>
                                <span class="font-semibold text-green-600">-{{ discount | currency:'ARS':'symbol':'1.0-0' }}</span>
                            </div>

                            <!-- Coupon Discount -->
                            <div *ngIf="selectedCoupon" class="flex justify-content-between align-items-center p-3 surface-100 border-round-lg border-left-3 border-blue-500">
                                <div class="flex align-items-center gap-2">
                                    <i class="pi pi-ticket text-blue-600"></i>
                                    <span class="text-700 font-medium">Cupón</span>
                                    <p-tag [value]="selectedCoupon.code" severity="info" [rounded]="true" size="small" />
                                </div>
                                <span class="font-semibold text-blue-600">-{{ couponDiscount | currency:'ARS':'symbol':'1.0-0' }}</span>
                            </div>

                            <!-- Shipping -->
                            <div class="flex justify-content-between align-items-center p-3 surface-100 border-round-lg">
                                <div class="flex align-items-center gap-2">
                                    <i class="pi pi-truck text-primary"></i>
                                    <span class="text-700 font-medium">Envío</span>
                                </div>
                                <p-tag [value]="getShippingText()" [icon]="getShippingIcon()" [severity]="getShippingSeverity()"
                                    [class]="isShippingFree() ? 'bg-green-100 text-green-700 border-green-200' : 'bg-blue-100 text-blue-700 border-blue-200'" [rounded]="true" />
                            </div>
                        </div>

                        <p-divider></p-divider>

                        <!-- Total -->
                        <div class="bg-primary-50 border-round-xl p-4 mb-4">
                            <div class="flex justify-content-between align-items-center">
                                <span class="text-xl font-bold text-primary-900">Total con IVA</span>
                                <span class="text-2xl font-bold text-primary-900">{{ total | currency:'ARS':'symbol':'1.0-0' }}</span>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="flex align-items-center gap-3 p-2 surface-100 border-round-lg mb-4">
                            <p-checkbox formControlName="acceptTerms" [binary]="true" [inputId]="'terms'" class="mt-1" />
                            <label for="terms" class="text-sm text-700 line-height-2 cursor-pointer m-0">
                                Acepto los
                                <a href="javascript:void(0)" (click)="openTermsDialog()" class="text-primary cursor-pointer font-medium">términos y condiciones</a>
                                y la
                                <a href="javascript:void(0)" (click)="openPrivacyDialog()" class="text-primary cursor-pointer font-medium">política de privacidad</a>
                            </label>
                        </div>

                        <!-- Pay Button -->
                        <div class="flex justify-content-center mb-3">
                            <p-button label="Pagar Ahora" [icon]="!checkoutForm.valid || !checkoutForm.get('acceptTerms')?.value ? 'pi pi-lock' : 'pi pi-wallet'" [raised]="true"
                                size="large" [disabled]="!checkoutForm.valid || !checkoutForm.get('acceptTerms')?.value" (onClick)="processPayment()" [loading]="isProcessing"
                                class="w-full" />
                        </div>

                        <!-- Security Notice -->
                        <div class="text-center p-3 surface-50 border-round-lg">
                            <div class="flex align-items-center justify-content-center gap-2 text-xs text-600">
                                <i class="pi pi-shield text-green-600"></i>
                                <span>Tu información está protegida con encriptación SSL</span>
                            </div>
                        </div>
                    </div>
                </p-panel>
            </div>
        </aside>
    </form>

</main>